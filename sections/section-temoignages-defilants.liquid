{% comment %}
  Section: Témoignages défilants (style Trustpilot)
  Thème: Impact (Shopify OS2.0)
  Description: bandeau de témoignages qui défilent en continu (marquee) + en‑tête note moyenne
  Aucune librairie externe requise.

  Installation:
  1) Enregistrez ce fichier en: sections/testimonials-marquee.liquid
  2) Ajoutez la section dans l’éditeur de thème, paramétrez l’en‑tête et ajoutez des blocs “Témoignage”.
  3) Vous pouvez dupliquer le contenu pour avoir assez de cartes (4+ recommandé).

  Options:
  - Titre, fond (couleur ou dégradé), marges verticales
  - Note moyenne (texte, valeur, total d’avis)
  - Vitesse du défilement (plus petit = plus rapide)
  - Cartes: titre, texte, auteur

  Accessibilité:
  - Pause au survol et au focus clavier
  - Rôle region + aria-label
{% endcomment %}

<section id="tmq-{{ section.id }}" class="tmq" aria-label="Témoignages clients">
  <div class="tmq-bg"></div>
  <div class="tmq-inner page-width">
    {% if section.settings.heading != blank or section.settings.rating_label != blank %}
      <div class="tmq-header">
        {% if section.settings.heading != blank %}
          <h2 class=.tmq-heading { color: var(--heading); margin: 0; font-weight: 800; letter-spacing: -0.01em; line-height: 1.1; font-size: clamp(28px, 5vw, 56px);} }</h2>
        {% endif %}
        <div class="tmq-rating">
          {% if section.settings.rating_label != blank %}
            <p class="tmq-rating-text">{{ section.settings.rating_label }}</p>
          {% endif %}
          {% if section.settings.rating_value != blank %}
            <span class="tmq-rating-value">{{ section.settings.rating_value }}</span>
            <p class="tmq-rating-text"><strong>/ 5</strong></p>
          {% endif %}
          <div class="tmq-stars" aria-hidden="true">
            {% for i in (1..5) %}
              <svg width="28" height="28" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" class="tmq-star"><rect width="32" height="32" fill="{{ section.settings.star_bg }}"></rect><path d="M9.2 27L16 21.8 22.8 27 20.2 18.6 27 13.4h-8.4L16 5l-2.6 8.4H5l6.8 5.2L9.2 27z" fill="#ffffff"/></svg>
            {% endfor %}
          </div>
        </div>
        {% if section.settings.rating_count != blank %}
          <div class="tmq-based-on"><p>basé sur <strong>{{ section.settings.rating_count }}</strong> avis</p></div>
        {% endif %}
      </div>
    {% endif %}

    <div class="tmq-marquee" data-speed="{{ section.settings.speed }}">
      <div class="tmq-track">
        <div class="tmq-list">
          {% for block in section.blocks %}
            <article class="tmq-card" {{ block.shopify_attributes }}>
              <div class="tmq-card-top">
                <div class="tmq-stars small" aria-hidden="true">
                  {% for i in (1..5) %}
                    <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" class="tmq-star"><rect width="32" height="32" fill="{{ section.settings.star_bg }}"></rect><path d="M9.2 27L16 21.8 22.8 27 20.2 18.6 27 13.4h-8.4L16 5l-2.6 8.4H5l6.8 5.2L9.2 27z" fill="#ffffff"/></svg>
                  {% endfor %}
                </div>
                {% if block.settings.title != blank %}
                  <h3 class="tmq-card-title">{{ block.settings.title }}</h3>
                {% endif %}
              </div>
              {% if block.settings.text != blank %}
                <p class="tmq-card-text">{{ block.settings.text }}</p>
              {% endif %}
              {% if block.settings.author != blank %}
                <p class="tmq-card-author">{{ block.settings.author }}</p>
              {% endif %}
            </article>
          {% endfor %}
        </div>
        {%- comment -%}
          On duplique la liste pour créer un défilement sans rupture
        {%- endcomment -%}
        <div class="tmq-list tmq-dup">
          {% for block in section.blocks %}
            <article class="tmq-card">
              <div class="tmq-card-top">
                <div class="tmq-stars small" aria-hidden="true">
                  {% for i in (1..5) %}
                    <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" class="tmq-star"><rect width="32" height="32" fill="{{ section.settings.star_bg }}"></rect><path d="M9.2 27L16 21.8 22.8 27 20.2 18.6 27 13.4h-8.4L16 5l-2.6 8.4H5l6.8 5.2L9.2 27z" fill="#ffffff"/></svg>
                  {% endfor %}
                </div>
                {% if block.settings.title != blank %}
                  <h3 class="tmq-card-title">{{ block.settings.title }}</h3>
                {% endif %}
              </div>
              {% if block.settings.text != blank %}
                <p class="tmq-card-text">{{ block.settings.text }}</p>
              {% endif %}
              {% if block.settings.author != blank %}
                <p class="tmq-card-author">{{ block.settings.author }}</p>
              {% endif %}
            </article>
          {% endfor %}
        </div>
      </div>
    </div>

  </div>

  <style>
    #tmq-{{ section.id }} {
      --padY: {{ section.settings.pad_y }}px;
      --bg: {{ section.settings.bg }};
      --bg2: {{ section.settings.bg2 }};
      --use-gradient: {{ section.settings.use_gradient | json }};
      --radius: {{ section.settings.card_radius }}px;
      --card-bg: {{ section.settings.card_bg }};
      --card-text: {{ section.settings.card_text }};
      --heading: {{ section.settings.heading_color }};
      --muted: {{ section.settings.muted }};
      --star-bg: {{ section.settings.star_bg }};
      --gap: 28px;
      --card-w: 520px;
      --speed: {{ section.settings.speed }}s;
    }}px;
      --bg: {{ section.settings.bg }};
      --bg2: {{ section.settings.bg2 }};
      --use-gradient: {{ section.settings.use_gradient | json }};
      --radius: {{ section.settings.card_radius }}px;
      --card-bg: {{ section.settings.card_bg }};
      --card-text: {{ section.settings.card_text }};
      --heading: {{ section.settings.heading_color }};
      --muted: {{ section.settings.muted }};
      --star-bg: {{ section.settings.star_bg }};
      --gap: 14px;
      --card-w: 320px;
      --speed: {{ section.settings.speed }}s;
    }
    #tmq-{{ section.id }} .tmq-bg { position: absolute; inset: 0; background: var(--bg); }
    #tmq-{{ section.id }}[data-has-gradient] .tmq-bg { background: linear-gradient(106deg, var(--bg), var(--bg2) 100%); }
    #tmq-{{ section.id }} .tmq-inner { position: relative; padding: var(--padY) 0; }

    /* Header */
    #tmq-{{ section.id }} .tmq-header { display: grid; gap: 8px; justify-items: center; text-align: center; margin-bottom: 18px; }
    #tmq-{{ section.id }} .tmq-heading { color: var(--heading); margin: 0; }
    #tmq-{{ section.id }} .tmq-rating { display: inline-flex; align-items: center; gap: 10px; margin-top: 8px; }
    #tmq-{{ section.id }} .tmq-rating-text { color: var(--muted); margin: 0; }
    #tmq-{{ section.id }} .tmq-rating-value { font-weight: 700; color: var(--heading); }
    #tmq-{{ section.id }} .tmq-stars { display: inline-flex; gap: 6px; }

    /* Marquee */
    #tmq-{{ section.id }} .tmq-marquee { position: relative; overflow: hidden; }
    #tmq-{{ section.id }} .tmq-track { display: flex; width: max-content; }
    #tmq-{{ section.id }} .tmq-list { display: inline-flex; gap: var(--gap); }

    /* Cards */
    #tmq-{{ section.id }} .tmq-card { width: var(--card-w); background: var(--card-bg); color: var(--card-text); border-radius: var(--radius); padding: 22px 26px; box-shadow: 0 10px 28px rgba(0,0,0,.12); border: 1px solid rgba(17,24,39,.08);} 
    #tmq-{{ section.id }} .tmq-card-title { font-size: 26px; font-weight: 800; margin: 10px 0 10px; text-align: center; color: var(--heading);} 
    #tmq-{{ section.id }} .tmq-card-text { margin: 0 0 14px; color: var(--card-text); line-height: 1.6; text-align: center;} 
    #tmq-{{ section.id }} .tmq-card-author { margin: 0; font-weight: 600; color: var(--heading); text-align: center;} 

    /* Animation */
    #tmq-{{ section.id }} .tmq-track { animation: tmq-scroll-{{ section.id }} var(--speed) linear infinite; }
    #tmq-{{ section.id }} .tmq-marquee:hover .tmq-track,
    #tmq-{{ section.id }} .tmq-marquee:focus-within .tmq-track { animation-play-state: paused; }

    @keyframes tmq-scroll-{{ section.id }} {
      from { transform: translateX(0); }
      to   { transform: translateX(calc(-100% / 2)); }
    }

    /* Responsive */
    @media (max-width: 768px){
      #tmq-{{ section.id }} { --card-w: 320px; --gap: 16px; }
      .tmq-card-title { font-size: 20px; }
    }} { --card-w: 260px; }
    }
  </style>

  <script>
    (function(){
      var root = document.getElementById('tmq-{{ section.id }}');
      if(!root) return;
      if({{ section.settings.use_gradient | json }}) root.setAttribute('data-has-gradient','');

      // Ajuste automatiquement la durée pour que la vitesse perçue reste cohérente si peu de cartes
      var track = root.querySelector('.tmq-track');
      var list  = root.querySelector('.tmq-list');
      if(track && list){
        var cards = list.children.length;
        if(cards < 4){
          track.style.animationDuration = ({{ section.settings.speed }} / 2) + 's';
        }
      }
    })();
  </script>
</section>

{% schema %}
{
  "name": "Témoignages défilants",
  "class": "section testimonials-marquee",
  "settings": [
    { "type": "text", "id": "heading", "label": "Titre", "default": "Nos clients le disent mieux que nous !" },
    { "type": "text", "id": "rating_label", "label": "Libellé note (ex: Excellent)", "default": "Excellent" },
    { "type": "text", "id": "rating_value", "label": "Note (ex: 4.7)", "default": "4.7" },
    { "type": "text", "id": "rating_count", "label": "Nombre d'avis (ex: 1 067)", "default": "1 067" },

    { "type": "color", "id": "star_bg", "label": "Couleur carré étoile", "default": "#00b67a" },

    { "type": "color", "id": "heading_color", "label": "Couleur titres", "default": "#111111" },
    { "type": "color", "id": "card_bg", "label": "Fond des cartes", "default": "#ffffff" },
    { "type": "color", "id": "card_text", "label": "Texte des cartes", "default": "#333333" },
    { "type": "color", "id": "muted", "label": "Texte secondaire", "default": "#4b5563" },

    { "type": "checkbox", "id": "use_gradient", "label": "Utiliser un dégradé de fond", "default": true },
    { "type": "color", "id": "bg", "label": "Couleur/debut dégradé", "default": "#ffffff" },
    { "type": "color", "id": "bg2", "label": "Fin dégradé", "default": "#ffffff" },

    { "type": "range", "id": "pad_y", "label": "Marge verticale", "min": 0, "max": 100, "step": 2, "unit": "px", "default": 32 },
    { "type": "range", "id": "card_radius", "label": "Arrondi des cartes", "min": 0, "max": 28, "step": 1, "unit": "px", "default": 12 },

    { "type": "range", "id": "speed", "label": "Vitesse (secondes – plus petit = plus rapide)", "min": 10, "max": 120, "step": 5, "default": 45 }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Témoignage",
      "settings": [
        { "type": "text", "id": "title", "label": "Titre", "default": "Résultat bluffant dès la première utilisation. ✨" },
        { "type": "textarea", "id": "text", "label": "Texte", "default": "Ce shampoing est tout simplement incroyable. Dès la première application, mes cheveux blancs étaient complètement couverts, et personne ne peut dire que j'utilise un produit colorant." },
        { "type": "text", "id": "author", "label": "Auteur", "default": "Sophie M." }
      ]
    }
  ],
  "max_blocks": 24,
  "presets": [
    { "name": "Témoignages défilants", "category": "Témoignages", "blocks": [ {"type": "testimonial"}, {"type": "testimonial"}, {"type": "testimonial"}, {"type": "testimonial"} ] }
  ]
}
{% endschema %}
